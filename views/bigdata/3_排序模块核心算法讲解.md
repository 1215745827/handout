# 第三章 | 排序模块核心算法讲解

## 前言

**C：** 要想面试不中"邪"，就得理论不停学。今天依然是我们的核心算法讲解，不过这回的主角是排序模块的相关算法，查老师会带着大家了解一下推荐系统项目排序模块的算法，详细解释一下逻辑回归算法。

本章节比上一章节还要难，还需要你有了解偏导数、概率论等相关高数知识，同学，挺住，我们之前说好的。

![image-20200606163905326](H:\CHARLES7C_TEACH\查老师的讲义\Charles7cHandouts\docs\bigdata\3_项目核心算法讲解(下).assets\image-20200606163905326.png)

## 1. 常见排序算法

在第一章节我们就提过了常见的排序模块算法，现在大家再一起回顾一下。

- 常用机器学习算法
  - **LR逻辑回归算法** 

  - GBDT(梯度提升决策树)+LR

  - FM(因子分解机算法)

- 常用深度学习算法
  - RBM(受限玻尔兹曼机算法)

  - DNN(神经网络)

  - wide & deep 模型

## 2. 逻辑回归算法

逻辑回归是著名的机器学习分类算法，通常应用于二分类问题场景，例如：垃圾邮件分类、赝品判断、舆情判断等。

### 2.1 逻辑回归算法步骤

1. 将X数据放入sigmoid函数中，为每一条样本计算一个预测值。

![image-20200606164649287](H:\CHARLES7C_TEACH\查老师的讲义\Charles7cHandouts\docs\bigdata\3_项目核心算法讲解(下).assets\image-20200606164649287.png)

2. 将预测值与真实值进行对比

   损失函数：![image-20200606164736299](H:\CHARLES7C_TEACH\查老师的讲义\Charles7cHandouts\docs\bigdata\3_项目核心算法讲解(下).assets\image-20200606164736299.png)

3. 对损失函数求导，并通过优化算法来最小化损失函数

   梯度下降算法，参数更新方式：![image-20200606164803764](H:\CHARLES7C_TEACH\查老师的讲义\Charles7cHandouts\docs\bigdata\3_项目核心算法讲解(下).assets\image-20200606164803764.png)

4. 当优化完成后，即可得到模型

### 2.2 在推荐系统中的应用

逻辑回归通常在推荐系统中的排序阶段使用， 本项目同样使用逻辑回归实现推荐排序。 排序的目的在于对召回集返回的每个用户待推荐的数百个物品， 进行 " 精挑细选"， 选择最合适推荐的商品。

逻辑回归原理之前讲过， 它的返回结果是一个概率， 概率在 0~1 之间。 通常逻辑回归我们的用法都是在分类问题中， 如果返回的概率大于 0.5， 那么最终预测的分类结果为 1， 如果返回的概率小于 0.5， 那么最终预测的分类结果为 0。 

依据这个特性， 它也非常适合在排序任务中， 因为 0~1 之间的返回概率恰好可以作为排序的标准。 此时我们不需要考虑它是否大于或者小于 0.5， 我们只需要取出这个概率， 一旦得到的结果概率越大， 那么就越适合推荐，概率越小， 那么越不适合推荐。  

在推荐系统排序阶段中， 推荐系统应该将所有可能获取到的特征都传递给逻辑回归，如：

- 召回阶段（ALS等）使用的特征Userid、Itemid
- Userid所对应的基础特征（如：性别、年龄等）
- Itemid所对应的基础特征（如：音乐类型、时长等等）
- 用户行为数据等
- .....

### 2.3 项目中的排序策略

在项目中， 排序阶段的实现方式如下： 

- 使用逻辑回归作为排序算法
- 传入特征
  - `userid`、`itemid`、`duration`、`age`、`gender`
- 标签特征
  - `active`，它通过用户行为数据鉴别，如果某用户对某歌曲收听时间大于1分钟（60秒），并且没有切歌，那么就代表用户"喜欢"该歌曲，`active`值为1，反之`active`值为0
  
- 训练出模型之后，对召回数据进行预测，最终得出`<userid，itemid，rating>`
- 对最终结果进行倒排，将`rating`值更高的排在前面，等待最终推荐
- 最终得到排序结果20首歌，进入过滤阶段

::: warning 注意

过滤原则有： 全局黑名单过滤、 个性黑名单过滤、 已经推荐过的歌曲过滤、 已经听过的歌曲过滤等等一些条件，我们的本次项目代码中没有实现此阶段。 

::: 

## 后记

**C：** 好了，到此为止，我们的算法理论学习完了，从下章节开始，我们将进行项目的开发准备和工程的搭建，估计这才是大多数同学所喜欢的部分了。