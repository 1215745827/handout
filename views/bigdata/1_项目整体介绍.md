---
title: 第一章 | 项目整体介绍
date: 2020-05-18
categories:
 - 云音乐大数据推荐系统
tags:
 - 推荐系统
---

::: tip

作者：查老师(Charles7c)  
原文：http://charles7c.gitee.io/handout/java/1_intro/day01_%E5%88%9D%E8%AF%86Java.html  
本文为查老师原创文章，商业转载请联系作者获得授权，非商业转载请注明出处。  
本文引用的内容，版权归原作者所有。如有侵权请务必邮件联系我，我会在收到邮件后24小时内进行删除！  

强烈推荐阅读 [《如何有效地报告 Bug》](https://www.chiark.greenend.org.uk/~sgtatham/bugs-cn.html)，更好的问题更容易获得帮助。

:::

## 前言

**C：** 从今天开始，查老师要带着大家从头儿实现一个云音乐大数据推荐系统。有关于推荐系统，查老师在预告中有两个案例介绍，同样也相信大家在日常生活中对这类产品不陌生，你好好想想哪些APP是越用越懂你的，那肯定在不同程度的用到了推荐系统啦。

第一天的我们，将主要学习一些理论，了解一下推荐系统及其应用场景，了解一下推荐系统的核心要素，再了解一下主流推荐系统的基本构成，最后就是对我们要实现的云音乐推荐系统做个推荐流程和项目架构的介绍。

查老师知道很多同学最讨厌的就是这个环节，但还是要提醒一下在读的同学：别小看理论，没有理论基础的支撑，仅靠实践是走不远也走不好的。

::: tip 历史知识

英国物理学家W·汤姆逊（1824—1907）曾两次走近电磁理论的边缘，接近电磁规律的发现，但未能取得成功，令人扼腕。

**W·汤姆逊一生的兴趣的重点在应用方面，忽视理论研究，缺乏科学的洞察力。** 一位英国传记作家曾这样评论他：“他能够翻过科学上崇山峻岭一般的障碍，不过他一经到达了山巅，就不能想象雾层以外的景色了。他只知道贴身的一切，他在科学上没有远大的预知力。他不能察觉光之电磁学含育在他自己的研究里”。

::: 

![cloudmusic1_0_0](http://img.muyoung.tech/cloudmusic1_0_0.png)

## 1. 推荐系统概述

### 1.1 推荐系统发展史

::: tip 历史知识

移动互联网、 人工智能和信息技术飞速发展， 人们的日常生活和消费行为发生了巨大的变化。 足不出户就能看遍天下大事， 动动手指就可以遍览商品万千。 20 年前逛遍商场、 货比三家的消费生活仿佛有一个世纪那么遥远。 那时商品种类也算丰富， 但商场货架是稀缺资源， 只有最畅销的商品才能挤上货架与消费者见面， 海量的 **长尾商品[1]** 却是门可罗雀。 然而伴随着互联网的兴起， 一切都发生了变化。 

1995 年电商鼻祖亚马逊(amazon.com)网站横空出世， 彻底改变了人们的购物生活。 只用了短短 5 年时间， 亚马逊就从"地球上最大的书店”进化为“最大的综合网络零售商"。 没有了实体货架的限制， 人们在网上接触到海量的商品，进入到信息爆炸的时代。
少则得， 多则惑。 如果明确知道要找的东西， 用户可以直接搜索。 但问题是， 在畅销品之外的海量长尾商品里， 一样有用户可能喜欢的优质商品和内容。 如何知晓并找到它们呢？这正是推荐系统可以大展拳脚的地方。 推荐系统需要在理解用户需求的基础上， 提供个性化内容来创造价值。 

推荐系统经过 20 多年的发展和沉淀， 逐渐成为一门独立的学科， 在日常生活中发挥了独特而巨大的作用。 据统计， 推荐系统在 Netflix (netflix.com)上带来了 80%的观影人次； 在 Youtube (youtube.com)上贡献了 60%的视频点击； 在亚马逊网站贡献了 30%的销售额， 其巨大的影响力有目共睹。 在深入探讨细节之前， 我们有必要回顾它的发展历史，梳理现状， 进而指出其发展方向。

真正意义上的推荐系统萌芽于 90 年代初期。 美国明尼苏达大学的 GroupLens 研究所(grouplens.org)在 1994 年为 Usenet 新闻组开发了最早的协同过滤系统。 1998 年亚马逊上线了基于物品的协同过滤算法并产生了良好的效果。 2000 年左右， 学者和投资人意识到，当时的推荐系统虽然能带来短期的销售增长， 但维持良好的顾客关系， 为用户展示有用信息来寻求更长远的发展才是更重要的，由此推荐系统成长放缓。

直到 2006 年 Netflix 公司举办了Netflix 大奖赛， 再次开启了推荐系统的大发展。 这是一个机器学习与数据挖掘的比赛， 目的是在全球征集推荐算法来提升 Netflix 电影评分的预测准确度。 谁能将准确率提升 10%， 谁就能拿走 100 万美元奖金。 一石激起千层浪， 各路英雄豪杰同场竞技， 一较高下。 2009 年 9月 BellKor 团队依靠矩阵因子分解机(Factorization Machine)和集成学习(Ensemble Learning)摘得桂冠。
2007 年第一届计算机协会(Association for Computing Machinery, ACM)推荐系统大会在美国举行。 这是推荐系统领域的顶级盛会和重要的国际论坛来展示推荐系统最近的研究成果、系统和方法， 它极大地推动了推荐系统的发展。 2016 年， YouTube 发表论文， 将深度神经网络应用推荐系统。 同年， 谷歌也发表论文， 介绍了在谷歌应用商店推荐系统中应用深度学习的方法。 近年来， 人们又在探索将强化学习(reinforcement learning)与推荐系统结合起来， 以提高用户的长期收益。 现在推荐系统可谓是遍地开花， 活跃在各个行业， 包括电子商务、 个性化广告、 个性化阅读等诸多领域。  

**注[1]：**  **长尾** （英语：The Long Tail），或译**长尾效应** ，最初由《连线》的总编辑克里斯·安德森（Chris Anderson）于2004年发表于自家的杂志中。而长尾商品一词则来自其2006年出版的畅销书《长尾理论》 。他在系统研究了亚马逊、 eBay 等互联网零售商， 以及沃尔玛等传统零售商的销售数据后，观察到一种符合统计规律的现象。 如果以数量为纵轴，以商品为横轴绘制一条需求曲线时，左侧热销商品需求高耸，右侧冷门商品需求持续走低， 无限延伸就像长长的尾巴。   

![cloudmusic1_1_1](http://img.muyoung.tech/cloudmusic1_1_1.png)

::: 

### 1.2 推荐系统的目的

对于推荐系统来说，想要理解它，需要探究它出现的根本目的。

- 对客户而言，推荐系统是为客户推荐**其可能喜欢，但没发现过的物品**  

- 对商家而言，推荐系统是为了 **增加收入** 

### 1.3 推荐系统的应用场景

了解目的之后，再看看现有的典型应用场景，这样未来你在解决问题的时候就可以有所借鉴。

- **电子商务领域：** 亚马逊、阿里巴巴、京东等

  ![cloudmusic1_1_2](http://img.muyoung.tech/cloudmusic1_1_2.png)

- **视频领域：** bilibili、Youtube、抖音等

  ![cloudmusic1_1_3](http://img.muyoung.tech/cloudmusic1_1_3.png)

  短视频领域里，抖音做的最好，之所以说抖音是新世纪的“精神鸦片”，那不就是因为它总是给你推送你喜欢的视频，刷上抖音的你，根本停不下来。

- **新闻领域：** 今日头条、腾讯新闻等

  ![cloudmusic1_1_4](http://img.muyoung.tech/cloudmusic1_1_4.png)

- **社交网络领域：** 微信、Facebook等

  ![cloudmusic1_1_5](http://img.muyoung.tech/cloudmusic1_1_5.png)

- **广告领域** 

  查老师的手机上，每天接收太多太多的推送和广告，越是精准的推送和广告，自然越能勾起我查看和购买的欲望，这也是推荐系统的范畴。

  ![cloudmusic1_1_6](http://img.muyoung.tech/cloudmusic1_1_6.png)

  ![cloudmusic1_1_7](http://img.muyoung.tech/cloudmusic1_1_7.png)

其实不仅仅是网络应用，现实生活中也是存在着各种`推荐系统`，例如：对于超市来讲，**在货架的物品摆放上、客户的动线安排方面** 都是有学问的。

::: tip 小知识

高层货架分区通常放置较小的品牌，区域品牌的商品。因为小品牌制造商通常没有足够的预算让自己的产品处于更好的地位。然而，也有一些特殊品牌或民族食品，会被放在较高的货架上，而且价格也不便宜，这些都是无论如何都会购买的忠实顾客，所以不要具体考虑商品的位置。

中间货架分层，即自上而下的第二层和第三层，通常被视为中心区域，有畅销书和其他主要品牌，受欢迎的商品一般放在货架的中央和消费者视线的前面。为了获得最好的地位，制造商有时不得不向超市付款。因为对于超市来说，在这一地区放置低成本的商品是没有利润的，所以你所能看到的基本上是价格更高或利润更高的商品。

儿童的视线分区，一般都是儿童喜欢的相关产品。如果你不把孩子留在家里，带他们去购物，一次购物平均要比平时多花10%到40%。

作者：佳晨信货架

原文地址：https://baijiahao.baidu.com/s?id=1665392601003055186&wfr=spider&for=pc

::: 

所以好好学学推荐系统，把它合理利用起来，提高你客户的满意度及产品收益吧！

## 2. 推荐系统的核心要素

想要实现一个推荐系统，你要先确认好`user`、`item`、`event&context`这三个核心要素，或者可以说是准备好这三部分基础数据。

### 2.1 用户(user)

`user`就是用户，用户是最关键的，代表着推荐系统要服务的对象。用户与推荐系统进行交互，推荐系统则为用户推荐个性化物品和内容。用户一般对应系统中用户业务数据表内的信息。

- 用户数据示例
  - 用户ID（user ID）：1
  - 用户名（user name）：小明
  - 注册时间（created date）：1590999922
  - 年龄（age）：18
  - 性别（gender）：男
  - 城市（city）：北京



### 2.2 物品和内容(item)

`item`就是物品和内容，在现实商场中，所有的商品就是`item`，在音乐APP中，所有的音乐就是`item`。推荐系统推荐合适的物品和内容，以满足用户个性化需要。物品和内容一般对应系统中物品业务数据表内的信息。

- 物品和内容数据示例（电商场景）
  - 物品ID（item ID）：100
  - 名称（name）：《查老师的讲义》
  - 描述（description）：小白入门编程，买它就够了。
  - 品类（category）：图书
  - 标签（tags）：小白、编程、编程入门
  - 作者姓名（author name）：Charles
  - 分享次数（shares）：5201314



### 2.3 事件和语境(event&context)

事件与语境一般对应系统中用户行为数据，事件是用户和系统的交互过程，代表用户的行为数据。语境泛指推荐系统与用户交互时所有相关的背景信息，包括时间、地点、设备、事件ID、用户反馈等。

事件和语境就是推荐系统给用户进行推荐的依据，这些依据的数据可以通过 **数据埋点** 来获取，例如某个用户在某个页面驻留了比较长的时间，那在系统中可以记录一条"xx用户驻留xx页面xx秒"的数据到日志中。一般通过`flume` 或者 `kafka` 等相关工具进行日志数据收集， 将数据保存到数据仓库后统一进行分析。  

- 事件与语境数据示例
  - 用户ID（user ID）：1
  - 物品ID（item ID）：100
  - 事件ID（event ID）:5001
  - 事件类型（event type）：页面浏览
  - 时间（timestamp）：1590999922
  - 来源（source）：http://charles7c.gitee.io/handout/



## 3. 推荐系统的主要构成

刚才提过了，推荐系统的目的是给客户进行个性化的物品推荐，推荐其更感兴趣的内容，从而增加用户体验和用户粘性， 最终达到增加销量的目的。 推荐系统直接需要面对的两个元素就是用户和物品，推荐系统需要做的就是为每一个用户，从成千上万的物品中，选出用户现在最可能感兴趣的那几件/几十件物品。将成千上万的物品筛选出几件/几十件物品，这个过程就是推荐系统做出推荐的过程。 要实现推荐过程，推荐系统一般需要由几个阶段和模块构成。  

### 3.1 召回模块

召回模块的作用是从物品和内容仓库（ **千百万数量级** ）中进行 **粗粒度筛选** ， **对每个用户** ，将百万级数据通过简单快速的方法筛选出 **千/百数量级** 的，用户可能感兴趣的物品和内容列表。 其中使用的方法或者算法必须 **简单快速** ，因为涉及数据量巨大，如果使用复杂算法可能会让运算时间非常长，正因如此它才需要用到大数据领域的技术。
它以高效的算法筛选出一小部分符合要求的物品 （通常耗时不超过几十毫秒）， 然后交给排序方法进行更加精细的打分和排序。 

**常用的召回算法有：**  

- **常规召回** （基于热门、基于用户分群等）
  
  - 基于热门：首先对 **所有用户** 的行为数据做统计，将该歌曲被 N 个用户听过作为热门歌曲的依据，对N进行倒序排列得到 Top N 首热门歌曲进行推荐 。
  - 基于分群：它是在基于热门的基础上对人群进行了一次细粒度划分， 比如待推荐用户是（男， 16 岁，
    北京），在用户数据中筛选与他相符的这一类人群， 然后再按照这类人群都听过的歌， 给待推荐用户进行热门歌曲的推荐。  
  - 例如： **热门** 歌曲中有一首邓丽君唱的《甜蜜蜜》 和 一首小潘潘唱的《学猫叫》，现在要推荐的用户是一位16岁的青少年( **分群** )，那么按照常规召回会把《学猫叫》推荐给他。
  
- **基于内容的召回** 
  
  - 通过物品的特征，计算物品之间的相似性，进行推荐召回，使用物品和内容数据中的特征计算。
  
- **基于协同过滤的召回**  

  通过分析用户行为数据， 来预测哪些用户对并未产生行为的物品进行偏好预测， 预测出偏好之后， 再对用户进行最终推荐。

- **其他召回方式（略）** 

### 3.2 排序模块

推荐系统中，排序模块需要对召回模块返回的物品或内容列表进行打分，然后优先返回高分物品和内容。排序阶段比召回阶段使用更多的物品特征和用户喜好数据，还要考虑用户的语境，所以排序模块的算法更复杂 。

**常见的排序算法有：** 

- **单点排序** 
  - 针对所有样本，把排序问题转化为分类、回归问题实现
  - 最常使用的算法是`LR(逻辑回归算法)`
  - 变种的方法有`GBDT(梯度提升决策树) + LR`、`FM(因子分解机算法)`等
- **其他排序方式** 
  - `BPR`成对排序（贝叶斯个性化排序）
  - 基于深度学习的排序算法：`RBM(受限玻尔兹曼机算法) `、`DNN(神经网络)  `、`wide & deep 模型 `等。

### 3.3 过滤模块

通常排序后的推荐物品和内容列表不会直接显示给用户， 需要使用更多的语境信息和商业逻辑来过滤这个列表。

- 常见的业务场景过滤策略有（电商业务）
  - 用户已经购买的物品
  - 不适合公开展示的品类需要过滤掉，例如成人用品等
  - 用户评分过低的商品，例如1星商品
  - 重复推荐的商品
  - 同型号商品要推荐利润率高的
  - 不要推荐促销活动中的爆款商品而浪费曝光

### 3.4 工作原理

了解完推荐系统的核心要素及构成，那这些要素及构成是如何使用和工作的？

图中橙色区域是物品和内容部分，仓库中保存着百万甚至千万数量级的待推荐物品。通常情况下，离线批处理会把物品和内容的简单特征抽取出来，保存到存储介质中备用。同时，更多特定的高阶特征，会被各种机器学习模型抽取出来，以便推荐引擎进行调用。

在经过召回、排序、过滤之后的推荐物品和内容在送达用户后，用户会做出反馈，被日志记录下来。这些用户反馈一方面可以提取用户偏好和交互历史、 语境信息。另一方面，还可以用来持续更新召回和排序模型，不断改善推荐系统的表现。

![cloudmusic1_3_1](http://img.muyoung.tech/cloudmusic1_3_1.png)

## 4. 云音乐推荐系统的项目架构及流程

### 4.1 项目需求

整个云音乐大数据推荐系统的业务背景，是为用户提供个性化的歌曲和歌单推荐服务， 增加用户粘性， 提升用户的体验。 其中歌曲指的是按首为单位的音乐单曲，歌曲来源为版权歌曲 + 自由歌曲 + 用户自定义上传歌曲。歌单为一些歌曲组成的集合，通常都是用户按照自己的兴趣或者按照自己定义的分类规则对相应歌曲做的归类，然后将这些歌曲放置在一个歌单中，歌单来源一般为用户自定义上传整理。

本项目旨在建立一套个性化音乐推荐系统，为不同的用户进行个性化的推荐，本项目所面对的用户分为：

1. 新用户/冷启动(最近 30天所听歌曲数量小于20首且听歌次数小于 100次)
   注： 冷启动用户不包含个性化推荐（FPG， ALS）。
2. 一般/活跃用户（最近 30 天所听歌曲数量大于20 首或听歌次数大于100次）

本系统将通过一系列的策略来为这两类用户进行音乐推荐。  

### 4.2 系统构成

云音乐大数据推荐系统同样使用推荐系统常用的结构：召回模块、排序模块、过滤模块。 其中过滤模块在真实的云音乐大数据推荐系统中有使用，但是咱们的项目中因为数据是自己造的， 所以过滤模块暂时没有 。

下面是云音乐推荐系统各个构成的应用算法。

- **召回模块**  

  - 常规召回（热门音乐召回 + 用户分群召回）
  - 基于协同过滤的召回（`ALS`算法实现）

  每一种召回都可以看成是一种推荐策略，只是它们的推荐侧重点不一致。 最终将多种召回策略的结果进行结合， 将结果集整体传入排序模块中 。

- **排序模块** 

  - 单点排序（`LR逻辑回归算法实现`）

  逻辑回归算法将用户信息、 音乐信息、 用户的行为信息一起当做特征， 使用这些训练数据传递进逻辑回归算法中。 训练的标签为“用户是否喜欢听该歌曲”， 对模型进行训练， 具体的算法细节会在之后的章节详细介绍。

  训练得到模型后， 对整体召回集中的内容， 为每一个用户对各自的召回集结果进行一 一预测， 对预测得到的得分进行倒排， 选出最终的 Top N传入过滤模块中。

- 过滤模块（真实项目中包含，本项目代码中不包含）

  - 全局黑名单过滤：一些涉及暴力、色情等等类型的歌曲进入全局黑名单列表，永远不进行推荐。
  - 用户级别个性化黑名单过滤：如三天内已经为用户推荐的歌曲进入用户个性化黑名单，每天进行更新。  

### 4.3 用户群

云音乐大数据推荐项目服务的用户可分为两类，分别是新用户与普通用户，新用户又称冷启动用户，顾名思议这类用户是新注册的人群。普通用户是已经注册过，并且使用该音乐软件有一段时间的用户 。

- 冷启动用户

  系统只掌握这类用户注册时填写的信息数据， 包括但不限于： 昵称、 年龄、 性别、 喜欢xx 类型音乐、 喜欢 xx 歌星、 兴趣、 地域等等。 但是系统并没有记录他们的行为数据， 或者记录的非常少他们的行为数据。 这类冷启动用户作为待推荐用户时，他们是缺少用户行为数据的， 这就导致无法使用一些依赖用户行为数据的推荐方法的使用（如： 基于协同过滤的推荐）。

- 普通用户

  系统掌握了这类用户注册时填写的信息数据， 也掌握了用户的行为数据。 这类普通用户作为待推荐用户时，可以使用所有系统中所涉及的推荐策略和方法。

### 4.4 功能构成

云音乐大数据推荐系统主要有两部分功能， 分别是个性化推荐歌曲与个性化推荐歌单功能， 其中个性化推荐歌曲是最主要和重要的功能。这两个功能都是离线型推荐，一天只推荐一次。在线型推荐是每次产生用户行为都实时更新推荐。

- **个性化歌曲推荐** 
  - 冷启动用户
    - 召回模块：全局热门召回 + 用户分群召回
    - 排序模块：随机选取召回集中的内容进行推荐，选取 Top 10 进行推荐
    - 过滤模块：采用全局黑名单过滤 + 用户个性化黑名单过滤
  - 普通用户
    - 召回模块：全局热门召回 + 用户分群召回 + `ALS协同过滤`召回
    - 排序模块：使用`LR`逻辑回归算法对召回集中的歌曲进行排序，选取 Top 10 进行推荐
    - 过滤模块：采用全局黑名单过滤 + 用户个性化黑名单过滤
- **个性化歌单推荐**  
  - 冷启动用户
    - 不进行个性化歌单推荐  
  - 普通用户
    - 使用关联规则算法挑选出整体待推荐歌单  
    - 随机选取 4 个歌单作为最终推荐结果  

### 4.5 推荐流程图

![cloudmusic1_4_1](http://img.muyoung.tech/cloudmusic1_4_1.png)

### 4.6 架构图

![cloudmusic1_4_2](http://img.muyoung.tech/cloudmusic1_4_2.png)

架构图中表示的是整个项目的数据流及架构， 现有项目的内容是红色框内的内容。

整体流程首先将业务数据及手机端埋点数据传输到 `Hive` 表中，至少包括用户信息表、音乐信息表、歌单信息表、用户行为数据表等。使用 `Spark` 对表中的数据进行操作，通过相关规则和算法，最终得到推荐表，保存到 `HDFS` 中。最后将内容写入 `Redis` 集群中， 供前端调用。

整个项目为离线推荐项目， 推荐的音乐每一天进行更新，也就是每一天都需要重新跑一遍该项目，其中用户信息表、 音乐信息表、歌单信息表都是按照最新的数据进行计算，用户行为数据表提取的是近 30 天的行为数据，使用类似窗口似的数据的取法，超过 30 天的数据不参与计算，这些都是业务上的考虑，因为可能人们听音乐的习惯有一定的周期性，例如最近喜欢听摇滚乐， 过段时间又喜欢上听乡村音乐了。

**数据源：**  手机 App 端打点日志数据， 使用 `Flume` 采集， 通过 `ETL` 工具处理将数据传到 `Hive` 表中（本项目不涉及， 本项目只是推荐系统模块的开发）。

**项目架构：** 项目架构包含技术主要为 `Hive`、 `Spark`、 `Spark MLlib`、` Redis`、 `推荐系统算法`

**数据流程如下：**

1. 手机 App 端埋点收集用户信息（`Flume`）；
2. `Flume` 采集用户信息日志数据并经过处理存储到 `Hive` 中；（项目代码中不包含， 此为上游数据）
3. 使用推荐系统算法对数据进行计算处理， 生成模型；
4. 调用 `Spark MLlib` 算法， 给用户进行个性化推荐；
5. 将推荐计算结果写入 `Redis `集群并提供给用户 App 端请求访问。

## 后记

**C：** 好了，第一天的推荐系统整体介绍就到这儿结束了，理论部分除了术语外还是比较容易理解的，只要是懂点编程，懂点程序设计的人群，那么看本章节就没什么问题。另外如果你觉得微信公众号阅读不方便，可以打开 http://charles7c.gitee.io/handout/ 网站阅读。

后面两个章节，我们会对项目的核心算法进行详细讲解，包括：协同过滤算法、`ALS`算法、逻辑回归算法，同样这两章节也需要一些高等数学知识，可以提前对基础矩阵运算、偏导数、概率论做做准备。

![cloudmusic1_4_3](http://img.muyoung.tech/cloudmusic1_4_3.png)